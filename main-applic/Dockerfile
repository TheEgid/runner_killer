# ------------------------ Stage 1: Builder ------------------------
FROM node:23.10.0-bookworm-slim AS builder

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN apt-get update && apt-get install -y \
  curl \
  openssl \
  --no-install-recommends \
  && rm -rf /var/lib/apt/lists/* \
  && apt-get clean

WORKDIR /app

# Corepack –¥–ª—è pnpm
RUN corepack enable

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
ENV NEXT_PUBLIC_BASE_PATH=/ui
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV NODE_TLS_REJECT_UNAUTHORIZED=0

# pnpm –≤—Å–µ–≥–¥–∞ —Ç—è–Ω–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ Verdaccio
ENV NPM_CONFIG_REGISTRY=http://verdaccio:4873
ENV PNPM_HOME=/root/.pnpm-store
ENV PATH=$PNPM_HOME:$PATH

# Copy deps
COPY package.json pnpm-lock.yaml ./

# –°–Ω–∞—á–∞–ª–∞ install, –ø–æ—Ç–æ–º update —á–µ—Ä–µ–∑ verdaccio
RUN --mount=type=cache,target=/root/.pnpm-store \
  pnpm install --frozen-lockfile --prefer-offline \
  && pnpm update --latest

# Copy code (–≤–∫–ª—é—á–∞—è .env –µ—Å–ª–∏ dev; –¥–æ–±–∞–≤—å—Ç–µ COPY .env . –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
COPY . .

# Select schema (—Å fallback)
RUN pnpm select-schema

# Generate Prisma (explicit schema path)
RUN pnpm prisma generate --schema=./prisma/schema.prisma

# Build
RUN pnpm build

# ------------------------ Stage 2: Application ------------------------
FROM node:23.10.0-bookworm-slim AS application

RUN apt-get update && apt-get install -y \
  curl \
  --no-install-recommends \
  && rm -rf /var/lib/apt/lists/* \
  && apt-get clean

WORKDIR /app

RUN corepack enable

# üëá registry –∏ pnpm cache –¥–æ—Å—Ç—É–ø–Ω—ã –∏ –≤ —Ä–∞–Ω—Ç–∞–π–º–µ
ENV TZ='Europe/Moscow'
ENV NEXT_PUBLIC_BASE_PATH=/ui
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV NODE_TLS_REJECT_UNAUTHORIZED=0
ENV NPM_CONFIG_REGISTRY=http://verdaccio:4873
ENV PNPM_HOME=/root/.pnpm-store
ENV PATH=$PNPM_HOME:$PATH

COPY --from=builder /app /app

EXPOSE 3006

CMD ["pnpm", "start"]
